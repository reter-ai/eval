;; Generator runtime (SRFI-121 core + helpers)
(define __gen_eof__ (eof-object))

(define (make-coroutine-generator proc)
  (let ((return #f) (resume #f))
    (lambda ()
      (call-with-current-continuation
       (lambda (outer)
         (set! return outer)
         (cond
          (resume (resume #f))
          (else
           (proc (lambda (result)
                   (call-with-current-continuation
                    (lambda (inner)
                      (set! resume inner)
                      (return result)))))
           (set! resume (lambda (v) (return __gen_eof__)))
           (return __gen_eof__))))))))

(define (generator->list gen)
  (let loop ((acc '()))
    (let ((v (gen)))
      (if (eof-object? v)
          (reverse acc)
          (loop (cons v acc))))))

(define collect generator->list)
(define eof? eof-object?)

(define (__gen_for_each__ f src)
  (if (pair? src)
      (for-each f src)
      (if (null? src)
          (if #f #f)
          (let loop ()
            (let ((v (src)))
              (if (not (eof-object? v))
                  (begin (f v) (loop))))))))

;; Polymorphic comprehension helpers (list + generator sources)
(define (__comp_map__ f src)
  (if (or (pair? src) (null? src))
      (map f src)
      (let loop ((acc '()))
        (let ((v (src)))
          (if (eof-object? v)
              (reverse acc)
              (loop (cons (f v) acc)))))))

(define (__comp_filter__ f src)
  (if (or (pair? src) (null? src))
      (filter f src)
      (let loop ((acc '()))
        (let ((v (src)))
          (if (eof-object? v)
              (reverse acc)
              (if (f v)
                  (loop (cons v acc))
                  (loop acc)))))))

(define (__comp_append_map__ f src)
  (if (or (pair? src) (null? src))
      (append-map f src)
      (let loop ((acc '()))
        (let ((v (src)))
          (if (eof-object? v)
              (apply append (reverse acc))
              (loop (cons (f v) acc)))))))
