;; eval/arrow-oo.scm -- OO methods for Arrow Tables and Arrays via __send__

;; ---- Top-level constructors and free functions ----

(define (Table ht)
  (__arrow_make_table__ (hash-table->alist ht)))

(define (read_csv path)     (__arrow_read_csv__ path))
(define (read_parquet path) (__arrow_read_parquet__ path))
(define (read_ipc path)     (__arrow_read_ipc__ path))

;; ---- Group-by helper (returns a dispatch closure) ----

(define (__arrow-make-group-by__ tbl key)
  (lambda (msg)
    (cond
      ((eq? msg 'sum)   (lambda (col) (__arrow_group_by_agg__ tbl key (list (cons col "sum")))))
      ((eq? msg 'mean)  (lambda (col) (__arrow_group_by_agg__ tbl key (list (cons col "mean")))))
      ((eq? msg 'min)   (lambda (col) (__arrow_group_by_agg__ tbl key (list (cons col "min")))))
      ((eq? msg 'max)   (lambda (col) (__arrow_group_by_agg__ tbl key (list (cons col "max")))))
      ((eq? msg 'count) (lambda () (__arrow_group_by_agg__ tbl key '())))
      ((eq? msg 'agg)   (lambda (ht) (__arrow_group_by_agg__ tbl key (hash-table->alist ht))))
      (else (error "GroupBy: unknown method" msg)))))

;; ---- Table __send__ dispatch ----

(define (__arrow-table-send__ obj msg)
  (cond
    ;; Properties (return values directly)
    ((eq? msg 'num_rows)       (__arrow_table_num_rows__ obj))
    ((eq? msg 'num_columns)    (__arrow_table_num_columns__ obj))
    ((eq? msg 'columns)        (__arrow_table_column_names__ obj))
    ((eq? msg 'schema)         (__arrow_table_schema__ obj))
    ((eq? msg 'length)         (__arrow_table_num_rows__ obj))

    ;; Methods (return lambdas)
    ((eq? msg 'column)
     (lambda (name-or-index)
       (__arrow_table_column__ obj name-or-index)))
    ((eq? msg 'select)
     (lambda (names)
       (__arrow_table_select__ obj names)))
    ((eq? msg 'drop)
     (lambda (name)
       (__arrow_table_drop__ obj name)))
    ((eq? msg 'filter)
     (lambda (col op val)
       (let ((op-sym (cond
                       ((eq? op >) '>)
                       ((eq? op <) '<)
                       ((eq? op >=) '>=)
                       ((eq? op <=) '<=)
                       ((eq? op =) '==)
                       ((eq? op equal?) '==)
                       ((symbol? op) op)
                       ((string? op) (string->symbol op))
                       (else op))))
         (__arrow_table_filter__ obj col op-sym val))))
    ((eq? msg 'sort)
     (lambda (col . rest)
       (let ((dir (if (pair? rest) (car rest) "asc")))
         (__arrow_table_sort__ obj col dir))))
    ((eq? msg 'head)
     (lambda (n)
       (__arrow_table_head__ obj n)))
    ((eq? msg 'tail)
     (lambda (n)
       (__arrow_table_tail__ obj n)))
    ((eq? msg 'slice)
     (lambda (offset length)
       (__arrow_table_slice__ obj offset length)))
    ((eq? msg 'add_column)
     (lambda (name arr)
       (__arrow_table_add_column__ obj name arr)))
    ((eq? msg 'remove_column)
     (lambda (name)
       (__arrow_table_remove_column__ obj name)))
    ((eq? msg 'rename)
     (lambda (old-name new-name)
       (__arrow_table_rename__ obj old-name new-name)))
    ((eq? msg 'join)
     (lambda (other key)
       (__arrow_table_join__ obj other key)))
    ((eq? msg 'group_by)
     (lambda (key)
       (__arrow-make-group-by__ obj key)))
    ((eq? msg 'to_csv)
     (lambda (path)
       (__arrow_write_csv__ obj path)))
    ((eq? msg 'to_parquet)
     (lambda (path)
       (__arrow_write_parquet__ obj path)))
    ((eq? msg 'to_ipc)
     (lambda (path)
       (__arrow_write_ipc__ obj path)))
    ((eq? msg 'to_string)
     (lambda ()
       (__arrow_table_to_string__ obj)))
    (else #f)))

;; ---- Array __send__ dispatch ----

(define (__arrow-array-send__ obj msg)
  (cond
    ;; Properties (return values directly)
    ((eq? msg 'length)     (__arrow_array_length__ obj))
    ((eq? msg 'null_count) (__arrow_array_null_count__ obj))
    ((eq? msg 'sum)        (__arrow_array_sum__ obj))
    ((eq? msg 'mean)       (__arrow_array_mean__ obj))
    ((eq? msg 'min)        (__arrow_array_min__ obj))
    ((eq? msg 'max)        (__arrow_array_max__ obj))
    ((eq? msg 'count)      (__arrow_array_count__ obj))

    ;; Methods (return lambdas)
    ((eq? msg 'ref)
     (lambda (i)
       (__arrow_array_ref__ obj i)))
    ((eq? msg 'to_list)
     (lambda ()
       (__arrow_array_to_list__ obj)))
    ((eq? msg 'unique)
     (lambda ()
       (__arrow_array_unique__ obj)))
    ((eq? msg 'sort)
     (lambda rest
       (let ((dir (if (pair? rest) (car rest) "asc")))
         (__arrow_array_sort__ obj dir))))
    ((eq? msg 'filter)
     (lambda (mask)
       (__arrow_array_filter__ obj mask)))
    ((eq? msg 'is_null)
     (lambda (i)
       (__arrow_array_is_null__ obj i)))
    (else #f)))

;; ---- Chain onto previous __send__ ----

(let ((__prev-send__ __send__))
  (set! __send__
    (lambda (obj msg)
      (cond
        ((%arrow-table? obj)  (__arrow-table-send__ obj msg))
        ((%arrow-array? obj)  (__arrow-array-send__ obj msg))
        (else (__prev-send__ obj msg))))))
